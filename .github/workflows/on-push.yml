name: 'ci'

on: push

jobs:
  # ==========================================
  # JOB 1: FRONTEND CHECKS
  # ==========================================
  frontend:
    name: Frontend (Lint, Typecheck, Test)
    runs-on: ubuntu-latest
    environment: development
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.3+sha512.c961d1e0a2d8e354ecaa5166b822516668b7f44cb5bd95122d590dd81922f606f5473b6d23ec4a5be05e7fcd18e8488d47d978bbe981872f1145d06e9a740017
      
      - name: Use Node.js 24
        uses: actions/setup-node@v6
        with:
          node-version: 24.14.0
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Generate Prisma client
        run: pnpm prisma:generate

      - name: Run lint (Biome)
        run: pnpm biome check ./src

      - name: Run typecheck
        run: pnpm typecheck

      - name: Run unit tests
        run: pnpm test

  # ==========================================
  # JOB 2: INFRASTRUCTURE CHECKS
  # ==========================================
  infrastructure:
    name: Infrastructure (Terraform & K8s)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: Setup Kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar -xz
          sudo mv kubeconform /usr/local/bin/

      - name: Initialize Terraform
        run: |
          terraform -chdir=terraform/persistent init -backend=false
          terraform -chdir=terraform/ephemeral init -backend=false

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Validate
        run: |
          terraform -chdir=terraform/persistent validate
          terraform -chdir=terraform/ephemeral validate

      - name: TFLint
        run: |
          tflint --chdir=terraform/persistent
          tflint --chdir=terraform/ephemeral

      - name: Kubernetes Manifest Validation
        run: |
          kubectl kustomize k8s/base | kubeconform -strict -summary --skip 'ManagedCertificate,BackendConfig'
          kubectl kustomize k8s/overlays/prod | kubeconform -strict -summary --skip 'ManagedCertificate,BackendConfig'