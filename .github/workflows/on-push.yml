name: 'ci'

on: push

jobs:
  # ==========================================
  # JOB 1: FRONTEND CHECKS
  # ==========================================
  frontend:
    name: Frontend (Lint, Typecheck, Test)
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0+sha512.6540583f41cc5f628eb3d9773ecee802f4f9ef9923cc45b69890fb47991d4b092964694ec3a4f738a420c918a333062c8b925d312f42e4f0c263eb603551f977
      
      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright Dependencies
        run: pnpm exec playwright install chromium --with-deps

      - name: Run lint (Biome)
        run: pnpm biome check ./src

      - name: Run typecheck
        run: pnpm typecheck

      - name: Run unit tests
        run: pnpm test

  # ==========================================
  # JOB 2: INFRASTRUCTURE CHECKS
  # ==========================================
  infrastructure:
    name: Infrastructure (Terraform & K8s)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # We still need pnpm to run the package.json scripts
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.0+sha512.6540583f41cc5f628eb3d9773ecee802f4f9ef9923cc45b69890fb47991d4b092964694ec3a4f738a420c918a333062c8b925d312f42e4f0c263eb603551f977
      
      - name: Use Node.js 22
        uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v4

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v6
        with:
          tflint_version: latest

      - name: Setup Kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar -xz
          sudo mv kubeconform /usr/local/bin/

      - name: Initialize Terraform Directories
        run: |
          cd terraform/persistent && terraform init -backend=false
          cd ../../terraform/ephemeral && terraform init -backend=false

      - name: Run Infrastructure & K8s Checks
        run: pnpm run infra:check